name: Deploy Backend (Blue-Green)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_PATH: /home/expo_tech/backend
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
      ALGORITHM: ${{ secrets.ALGORITHM }}
      AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.AUTH_PROVIDER_X509_CERT_URL }}
      AUTH_URI: ${{ secrets.AUTH_URI }}
      CLIENT_EMAIL: ${{ secrets.CLIENT_EMAIL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_X509_CERT_URL: ${{ secrets.CLIENT_X509_CERT_URL }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      EXPO_APP_PASSWORD: ${{ secrets.EXPO_APP_PASSWORD }}
      EXPO_EMAIL: ${{ secrets.EXPO_EMAIL }}
      EXPO_FRONT_URL: ${{ secrets.EXPO_FRONT_URL }}
      GCP_BUCKET_NAME: ${{ secrets.GCP_BUCKET_NAME }}
      HOST_SMTP: ${{ secrets.HOST_SMTP }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      PORTA_SMTP: ${{ secrets.PORTA_SMTP }}
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      PRIVATE_KEY_ID: ${{ secrets.PRIVATE_KEY_ID }}
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      TOKEN_URI: ${{ secrets.TOKEN_URI }}
      TYPE: ${{ secrets.TYPE }}
      UNIVERSE_DOMAIN: ${{ secrets.UNIVERSE_DOMAIN }}
      VM_HOST: ${{ secrets.VM_HOST }}
      VM_PORT: ${{ secrets.VM_PORT }}
      VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
      VM_USER: ${{ secrets.VM_USER }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker Images
        run: |
          IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/expo_tech_backend"
          echo "Build & Push das imagens blue e green"
          docker build -t "${IMAGE_BASE}:blue" .
          docker push "${IMAGE_BASE}:blue"
          docker build -t "${IMAGE_BASE}:green" .
          docker push "${IMAGE_BASE}:green"

      - name: Copy Compose & Nginx to VM
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "docker-compose.yml,nginx/nginx.conf"
          target: "${{ env.DEPLOY_PATH }}"

      - name: SSH Deploy Backend Blue-Green
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script_stop: false
          envs: ACCESS_TOKEN_EXPIRE_MINUTES,ALGORITHM,AUTH_PROVIDER_X509_CERT_URL,AUTH_URI,CLIENT_EMAIL,CLIENT_ID,CLIENT_X509_CERT_URL,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,EXPO_APP_PASSWORD,EXPO_EMAIL,EXPO_FRONT_URL,GCP_BUCKET_NAME,HOST_SMTP,MONGODB_URI,PORTA_SMTP,PRIVATE_KEY,PRIVATE_KEY_ID,PROJECT_ID,SECRET_KEY,TOKEN_URI,TYPE,UNIVERSE_DOMAIN,DEPLOY_PATH
          script: |
            set -e
            DEPLOY_PATH=${DEPLOY_PATH}
            IMAGE_BLUE="${DOCKERHUB_USERNAME}/expo_tech_backend:blue"
            IMAGE_GREEN="${DOCKERHUB_USERNAME}/expo_tech_backend:green"
            NETWORK="backend_net"

            echo "===== Iniciando deploy Blue-Green do Backend ====="
            cd $DEPLOY_PATH

            echo "Gerando arquivo .env"
            cat <<EOF > .env
            ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
            ALGORITHM=${ALGORITHM}
            AUTH_PROVIDER_X509_CERT_URL=${AUTH_PROVIDER_X509_CERT_URL}
            AUTH_URI=${AUTH_URI}
            CLIENT_EMAIL=${CLIENT_EMAIL}
            CLIENT_ID=${CLIENT_ID}
            CLIENT_X509_CERT_URL=${CLIENT_X509_CERT_URL}
            DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME}
            EXPO_APP_PASSWORD=${EXPO_APP_PASSWORD}
            EXPO_EMAIL=${EXPO_EMAIL}
            EXPO_FRONT_URL=${EXPO_FRONT_URL}
            GCP_BUCKET_NAME=${GCP_BUCKET_NAME}
            HOST_SMTP=${HOST_SMTP}
            MONGODB_URI=${MONGODB_URI}
            PORTA_SMTP=${PORTA_SMTP}
            PRIVATE_KEY=${PRIVATE_KEY}
            PRIVATE_KEY_ID=${PRIVATE_KEY_ID}
            PROJECT_ID=${PROJECT_ID}
            SECRET_KEY=${SECRET_KEY}
            TOKEN_URI=${TOKEN_URI}
            TYPE=${TYPE}
            UNIVERSE_DOMAIN=${UNIVERSE_DOMAIN}
            EOF

            echo "Arquivo .env criado com sucesso!"
            echo "Conteúdo do .env:"
            cat .env

            echo "Criando rede (se não existir)"
            docker network create $NETWORK >/dev/null 2>&1 || true

            echo "Login no Docker Hub"
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin || true

            echo "Pull das imagens"
            docker pull "$IMAGE_BLUE" || true
            docker pull "$IMAGE_GREEN" || true

            echo "Verificando se o Mongo está ativo..."
            if docker ps --format '{{.Names}}' | grep -q "^mongo$"; then
              echo "Mongo já está rodando."
            else
              echo "Mongo não está rodando — iniciando..."
              docker compose -f "$DEPLOY_PATH/docker-compose.yml" up -d mongo
            fi

            echo "Removendo container temporário (se existir)"
            docker rm -f backend-green-temp >/dev/null 2>&1 || true

            echo "Subindo backend-green-temp"
            docker run -d --name backend-green-temp --env-file .env --network $NETWORK "$IMAGE_GREEN"

            echo "Aguardando inicialização..."
            sleep 5

            echo "Executando healthcheck..."
            ATTEMPTS=0
            MAX_ATTEMPTS=10
            HEALTHY=false

            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              STATUS=$(docker run --rm --network "$NETWORK" curlimages/curl:latest -s -o /dev/null -w "%{http_code}" http://backend-green-temp:8000/api/health || echo "000")
              echo "Tentativa $((ATTEMPTS+1))/$MAX_ATTEMPTS - HTTP $STATUS"
              if [ "$STATUS" = "200" ]; then
                HEALTHY=true
                break
              fi
              ATTEMPTS=$((ATTEMPTS+1))
              sleep 3
            done

            if [ "$HEALTHY" != true ]; then
              echo "Healthcheck falhou — revertendo."
              docker logs backend-green-temp || true
              docker rm -f backend-green-temp || true
              exit 1
            fi

            echo "Healthcheck OK — promovendo nova versão"
            docker stop backend-blue >/dev/null 2>&1 || true
            docker rm backend-blue >/dev/null 2>&1 || true

            docker run -d --name backend-blue --env-file .env --network $NETWORK -p 8000:8000 "$IMAGE_GREEN"

            docker rm -f backend-green-temp >/dev/null 2>&1 || true

            echo "Recarregando Nginx..."
            docker exec frontend-proxy nginx -s reload || echo "Proxy não encontrado."

            echo "===== Deploy concluído com sucesso ====="
